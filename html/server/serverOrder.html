<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>

		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/appfont.css" rel="stylesheet" />
		<link href="../../css/main.css" rel="stylesheet" />
		<link href="../../css/chart.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css" />

	</head>

	<body>
		<style>
			.button {
				color: #fff;
				border: 1px solid #4cd964;
				background-color: #4cd964;
				font-size: 18px;
				display: block;
				width: 100%;
				margin-bottom: 10px;
				padding: 15px 0
			}
			
			.mui-form {
				color: #636363;
			}
			.pricenum {
				width: auto !important;
				float: right !important;
				color: #FFC90E !important;
				font-size: 17px !important;
			}
		</style>
		<div class="windows_bg" id="dialog" style="display: none;">
			<!--通用弹窗标准-->
			<div class="windows_box">
				<!--一按钮状态-->
				<div class="info_box two_btn" id="dialogone" style="display: none;padding-top: 0px;">
					<p style="padding: 0px 0px;padding-top: 10px;">订单详情</p>
					<div id="text" style="font-size: 16px;color: #636363;text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;您好，因为旅居需要入住的时间周期较长，在您支付前，商家需要最终为您确定并安排床位，在商家确认并安排好您的入住床位和行程后，您就可以支付并完成最终预定了。</br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;请您密切关注我们的通知消息或【待支付】订单！</div>
					<a href="#" id="continue">继续填写</a>
					<a href="#" id="notice" style="text-align: center;">下订单</a>
				</div>
				<!--两按钮状态-->
				<div class="info_box two_btn" id="dialogtwo">
					<p id="title">订单就要完成了，你确定要离开吗？</p>
					<a href="#" id="casncel">继续填写</a>
					<a href="#" class="left_line" id="close">确定</a>
				</div>
				<!--三按钮状态-->
				<!--<div class="info_box nbg_bgn">
		<p>请先选路段，再选备件仓库请先选路段，再选备件仓库请先选路段，再选备件仓库请先选路段，再选备件仓库</p>
		<a href="#">重试</a>
		<a href="#">确认绑定</a>
		<a href="#">暂存</a>
		</div>-->
			</div>
		</div>
		<!--主界面部分-->
		<header id="header" class="mui-bar mui-bar-nav">
			<h1 class="mui-title">预约服务</h1>
			<a id="back" href="#offCanvasSide" class="mui-icon icon_app_02 mui-action-menu mui-icon-left-nav mui-pull-left"></a>
		</header>

		<div class="fault_main" style="top:45px">
			<div class="form_info">
				<div><label>服务地址</label>
					<dd><input id="address" type="text" class="input_sys2" placeholder="请填写准确地址"></dd>
				</div>
				<div style="margin:10px 0px 10px 0px;"><label>联系电话</label>
					<dd><input id="phone" type="text" class="input_sys2" placeholder="请填写联系人电话"></dd>
				</div>
			</div>
			<div class="line_box"></div>
			<div class="mui-form">
				<div class="form_info">
					<div><label style="width: 100px;">数量</label>
						<div class="mui-numbox" style="margin-left: 100px;" data-numbox-min='0' id="quantity">
							<!-- "-"按钮，点击可减小当前数值 -->
							<button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
							<input class="mui-numbox-input" type="number" />
							<!-- "+"按钮，点击可增大当前数值 -->
							<button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
						</div>
						<!--<dd><input id="quantity" type="number" class="input_sys1" placeholder="未填写"></dd>-->
					</div>
				</div>
				<div class="form_info" id="divprice" style="display: none;">
					<div><label style="width: 100px;">金额</label>
						<label class="pricenum" id="payprice">3999.00￥</label>
					</div>
				</div>
				<div style="border-top: 1px solid #e8e8e8;"></div>
				<ul>
					<li id="dtPicker">
						<a href="#">预约时间<span id="txtOccurTime">选择</span></a>
					</li>
				</ul>
			</div>
			<div class="line_box"></div>
			<div class="mui-form">
				<ul>
					<li class="form_tp">预约备注</li>
					<li><textarea id="remark" class="text_box" style="font-size:16px;" placeholder="请填写需要注意的事项"></textarea></li>
				</ul>
			</div>
			<div class="line_box"></div>
			<!--<div>
				<a href="#" class="fault_btn_ok long_btn" id="confirm">
				<i class="mui-icon icon_cloud"></i><span>确定订单</span>
			</a>
		</div>-->
			<div id="confirm" class="mui-content-padded">
				<button id="btnSave" type="button" class="mui-btn button">确认订单</button>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/muifun.js"></script>
		<script src="../../js/localDatabase.js"></script>
		<script src="../../js/post.js"></script>
		<script src="../../js/dao.js"></script>
		<script src="../../js/shop.js"></script>
		<script type="text/javascript" src="../../js/compareTimes.js"></script>
		<script>
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
			var _shop = new Shop();
			var _dataAccess = new DataAccess();
			var productId;
			var _self;
			var bookedDate;
			var FaultEntity;
			var categoryId;
			mui.plusReady(function() {
				_self = plus.webview.currentWebview();
				console.log(JSON.stringify(_self.data));
				productId = _self.data.ProductId;
				categoryId = _self.data.CategoryId;
				console.log(productId + "______________" + categoryId);
				FaultEntity = _self.data;
				initpage();
			});

			function initpage() {
				document.getElementById('phone').value = _dataAccess.getUser().Mobile;
				mui('#quantity').numbox().setOption('min', FaultEntity.MinQuantity);
				mui('#quantity').numbox().setOption('max', FaultEntity.MaxQuantity);
				//				console.log(FaultEntity.MinQuantity + '========' + FaultEntity.MaxQuantity);
				//				mui('#quantity').numbox().setValue(FaultEntity.MinQuantity);
//				mui('#dtPicker').on('tap', 'a', function() { 
//					var curTime = (new Date()).Format("yyyy-MM-dd");
//					//					var curTime = document.getElementById("txtOccurTime").innerHTML;
//					var year = new Date().getFullYear();
//					var opt = {
//						"type": "date",
//						"value": curTime,
//						"beginYear": year - 1,
//						"endYear": year
//					};
//					var picker = new mui.DtPicker(opt);
//					picker.show(function(rs) {
//						document.getElementById("txtOccurTime").innerHTML = rs.text;
//						bookedDate = rs.text;
//						picker.dispose();
//					});
//				});
				mui('#dtPicker').on('tap', 'a', function() {
					var curTime = (new Date()).Format("yyyy-MM-dd hh:mm");
					//					var curTime = document.getElementById("txtOccurTime").innerHTML;
					var year = new Date().getFullYear();
					var opt = {
						"type": "datetime",
						"value": curTime,
						"beginYear": year,
						"endYear": year + 1
					};
					var picker = new mui.DtPicker(opt);
					picker.show(function(rs) {
						//						console.log(dateStrToMillis(rs.text)+'===结束==='+dateStrToMillis(curTime));
						if(dateStrToMillis(rs.text) < dateStrToMillis(curTime)) {
							mui.toast('不能选择之前的时间');
							picker.dispose();
						} else if((dateStrToMillis(rs.text) - dateStrToMillis(curTime)) / (1000 * 60 * 60 * 24) > 60) {
							mui.toast('抱歉，只能提前60天预约，请重新选择');
							picker.dispose();
						} else {
							document.getElementById("txtOccurTime").innerHTML = rs.text;
							bookedDate = rs.text;
							picker.dispose();
						}
					});
				});
				document.getElementById('confirm').addEventListener('tap', function() {
					var quantitynum = mui('#quantity').numbox().getValue();
					if(getValue('address') == '') {
						mui.toast('请填写服务地址');
						return;
					}
					if(getValue('phone') == '') {
						mui.toast('请填写联系电话');
						return;
					}
					if(quantitynum < FaultEntity.MinQuantity) {
						mui.toast('数量不能少于' + FaultEntity.MinQuantity);
						return;
					}
					if(quantitynum > FaultEntity.MaxQuantity) {
						mui.toast('数量不能大于' + FaultEntity.MaxQuantity);
						return;
					}
					if(document.getElementById("txtOccurTime").innerHTML == '选择') {
						mui.toast('请选择预约时间');
						return;
					}
					//					plus.nativeUI.showWaiting();
					document.getElementById("text").innerHTML = '&nbsp;&nbsp;&nbsp;服务地址：' + getValue('address') + '</br>&nbsp;&nbsp;&nbsp;联系电话：' + getValue('phone') + '</br>&nbsp;&nbsp;&nbsp;数量：' + quantitynum + '</br>&nbsp;&nbsp;&nbsp;预约时间：' + document.getElementById("txtOccurTime").innerHTML + '</br>&nbsp;&nbsp;&nbsp;预约备注：' + getValue('remark') + '</br>&nbsp;&nbsp;&nbsp;价格：' + (quantitynum * FaultEntity.Price) + '元';
					dialog.style.display = 'block';
					document.getElementById('dialogone').style.display = 'block';
					document.getElementById('dialogtwo').style.display = 'none';
//					console.log('productId:' + productId + 'address:' + getValue('address') + 'phone:' + getValue('phone') + 'quantity:' + quantitynum + 'peopleAmount:' + peopleAmountnum);
					//					_shop.MakeOrder(productId, quantitynum, peopleAmountnum, getValue('address'), getValue('phone'), getValue('remark'), document.getElementById("txtOccurTime").innerHTML, 1, function(result) {
					//						console.log(JSON.stringify(result));
					//						plus.nativeUI.closeWaiting();
					//						if(result.status == 1) {
					//							mui.toast('创建订单成功');
					//							//							plus.webview.currentWebview().close();
					//						} else {
					//							mui.toast('创建订单失败，请确认信息是否正确');
					//						}
					//					}, function() {
					//						plus.nativeUI.closeWaiting();
					//						mui.toast('请求失败');
					//					});
				});
				document.getElementById('casncel').addEventListener('tap', function() {
					dialog.style.display = 'none';
				});
				document.getElementById('continue').addEventListener('tap', function() {
					dialog.style.display = 'none';
				});
				document.getElementById('close').addEventListener('tap', function() {
					plus.webview.currentWebview().close();
				});
				document.getElementById('back').addEventListener('tap', function() {
					mui.back();
				});
				document.getElementById('notice').addEventListener('tap', function() {
					//					var task = plus.webview.getWebviewById('product_details.html');
					//					mui.fire(task, 'CreateOrder');
					//
					//					var main = plus.webview.getWebviewById('main.html');
					//					mui.fire(main, 'CreateOrder', {});
					//					var task = plus.webview.getWebviewById('html/member/shop_order_list.html');
					//					mui.fire(task, 'listRefresh0');
					//					toMain();
					//					//					mui.back();
					//					plus.webview.getWebviewById('createorder.html').close();
					var quantitynum = mui('#quantity').numbox().getValue();
					plus.nativeUI.showWaiting();
					_shop.MakeServiceOrder(productId, categoryId, quantitynum, getValue('address'), getValue('phone'), getValue('remark'), document.getElementById("txtOccurTime").innerHTML, function(result) {
						console.log(JSON.stringify(result));
						plus.nativeUI.closeWaiting();
						if(result.status == 1) {
							mui.toast('创建订单成功');
							var dialog = document.getElementById('dialog');
							dialog.style.display = 'none';
							gotoHtml("../shop/pay.html",result.result.Id);
							//							plus.webview.currentWebview().close();
						} else {
							mui.toast('创建订单失败，请确认信息是否正确');
						}
					}, function() {
						plus.nativeUI.closeWaiting();
						mui.toast('请求失败');
					});
				});
				 mui('body').on('change','.mui-numbox', function() {
						calculateprice();
					});

			}

			function getValue(ElementId) {
				return document.getElementById(ElementId).value;
			}
			
			function calculateprice() {
				var Price = FaultEntity.Price;
				var quantitynum = mui('#quantity').numbox().getValue();
				var totalprice = Price * quantitynum;
				if(totalprice!= 0) {
					document.getElementById('divprice').style.display = 'block';
					document.getElementById('payprice').innerHTML = toDecimal2(totalprice) + '￥';
				}else{
					document.getElementById('divprice').style.display = 'none';
				}
			}

			//			var inputTap = false;
			//			mui('.mui-card').on('tap', '.allSelect', function() {
			//				inputTap = true;
			//			});
			//			mui('.mui-card').on('tap', '.mui-navigate-right', function() {
			//				if(inputTap) {
			//					inputTap = false;
			//					return;
			//				}
			//				//记录状态
			//				var li = this.parentNode;
			//				var ul = this.parentNode.querySelector('.mui-table-view');
			//				var _style = ul.style.display;
			//				//关闭同级菜单
			//				var parent = this.parentNode.parentNode.children;
			//				for(var i = 0; i < parent.length; i++) {
			//					if(!!parent[i].querySelector('.mui-table-view')) {
			//						parent[i].querySelector('.mui-table-view').style.display = '';
			//						removeClass(parent[i], 'mui-active');
			//					}
			//				}
			//				//更改状态
			//				if(_style == 'block') {
			//					ul.style.display = '';
			//					removeClass(li, 'mui-active');
			//				} else {
			//					ul.style.display = 'block';
			//					addClass(li, 'mui-active');
			//				}
			//				//关闭下级子菜单
			//				var children = ul.children;
			//				for(var i = 0; i < children.length; i++) {
			//					var child = children[i].querySelector('.mui-table-view');
			//					if(!!child) {
			//						child.style.display = '';
			//						removeClass(children[i], 'mui-active');
			//					}
			//				}
			//			});

			function hasClass(obj, cls) {
				return obj.className.match(new RegExp('(\\s|^)' + cls + '(\\s|$)'));
			}

			function addClass(obj, cls) {
				if(!this.hasClass(obj, cls)) obj.className += " " + cls;
			}

			function removeClass(obj, cls) {
				if(hasClass(obj, cls)) {
					var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');
					obj.className = obj.className.replace(reg, '');
				}

			}
			var old_back = mui.back;
			mui.back = function(event) {
				var dialog = document.getElementById('dialog');
				if(dialog.style.display == 'none') {
					dialog.style.display = 'block';
					document.getElementById('dialogone').style.display = 'none';
					document.getElementById('dialogtwo').style.display = 'block';
					return;
				} else {
					dialog.style.display = 'none';
					return;
				}
				return false;
			};
			function gotoHtml(u, datas) {
				mui.openWindow({
					url: u,
					id: u,

					show: {
						aniShow: 'pop-in'
					},
					waiting: {
						autoShow: true, //自动显示等待框，默认为true
						title: '正在加载...', //等待对话框上显示的提示内容
					},
					extras: {
						data: datas,
						pageId:'serverOrder.html'
					}
				});
			}
			var toMain = function() {
				//						$.fire(mainPage, 'show', null);
				setTimeout(function() {
					mui.openWindow({
						id: 'main.html',
						url: '../../main.html',
						show: {
							aniShow: 'pop-in'
						},
						waiting: {
							autoShow: false
						}
					});
				}, 0);
			};
						//保留2位小数。
			function toDecimal2(x) {
				var f = parseFloat(x);
				if(isNaN(f)) {
					return false;
				}
				var f = Math.round(x * 100) / 100;
				var s = f.toString();
				var rs = s.indexOf('.');
				if(rs < 0) {
					rs = s.length;
					s += '.';
				}
				while(s.length <= rs + 2) {
					s += '0';
				}
				return s;
			}
		</script>
	</body>

</html>