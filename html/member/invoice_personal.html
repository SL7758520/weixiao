<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/mui.picker.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../css/appfont.css" rel="stylesheet" />
		<link href="../../css/main.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/icons-extra.css" />

		<style type="text/css">
			html,
			body {
				background-color: #F3F3F3;
			}
			
			.form_info {
				border-bottom: 1px solid #F3F3F3;
			}
			
			.form_info label {
				width: 75px;
				font-size: 16px;
			}
			
			.form_info .input_sys1 {
				font-size: 14px;
			}
			
			.button {
				color: #fff;
				border: 1px solid #4cd964;
				background-color: #4cd964;
				font-size: 18px;
				display: block;
				width: 100%;
				margin-bottom: 10px;
				padding: 15px 0
			}
		</style>
	</head>

	<body>
		<div class="windows_bg" id="dialog" style="display: none;">
			<!--通用弹窗标准-->
			<div class="windows_box">
				<!--一按钮状态-->
				<div class="info_box" id="dialogone" style="display: none;text-align: left;">
					<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;您好，您的发票申请订单已经成功提交，请您到发票索取历史查看当前订单进度以及物流信息，如有疑问，请致电客服服务热线010-88888888</p>
					<a href="#" id="notice" style="text-align: center;">确定</a>
				</div>
				<!--两按钮状态-->
				<div class="info_box two_btn" id="dialogtwo">
					<p id="title">订单就要完成了，你确定要离开吗？</p>
					<a href="#" id="casncel">继续填写</a>
					<a href="#" class="left_line" id="close">确定</a>
				</div>
				<!--三按钮状态-->
				<!--<div class="info_box nbg_bgn">
		<p>请先选路段，再选备件仓库请先选路段，再选备件仓库请先选路段，再选备件仓库请先选路段，再选备件仓库</p>
		<a href="#">重试</a>
		<a href="#">确认绑定</a>
		<a href="#">暂存</a>
		</div>-->
			</div>
		</div>
		<header class="mui-bar mui-bar-nav">
			<a id="back" href="#offCanvasSide" class="mui-icon icon_app_02 mui-action-menu mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">个人发票申请</h1>
		</header>
		<div class="mui-content">
			<div class="form_info">
				<div><label>发票金额</label>
					<dd><input id="price" type="text" class="input_sys1" readonly></dd>
				</div>
			</div>
			<div class="form_info">
				<div><label>联系人</label>
					<dd><input id="name" type="text" class="input_sys1" placeholder="请输入联系人"></dd>
				</div>
			</div>
			<div class="form_info">
				<div><label>联系电话</label>
					<dd><input id="phoneNumber" type="text" class="input_sys1" placeholder="请输入联系电话"></dd>
				</div>
			</div>
			<div class="mui-form">
				<ul>
					<li id="showUserPicker">
						<a href="#" style="color: #000;">所在地区<span id="region">选择</span></a>
					</li>
				</ul>
			</div>
			<div class="mui-form">
				<ul>
					<li><textarea id="txtDescription" class="text_box" style="font-size: 14px;" placeholder="详细地址"></textarea></li>
				</ul>
			</div>
			<div class="mui-form">
				<ul>
					<li class="form_tp">备注</li>
					<li><textarea id="txt" class="text_box" style="font-size: 14px;" placeholder="请添加备注"></textarea></li>
				</ul>
			</div>

		</div>
		<div id="confirm" class="mui-content-padded">
			<button id="btnSave" type="button" class="mui-btn button">提&nbsp;&nbsp;&nbsp;&nbsp;交</button>
		</div>
		<script src="../../js/mui.min.js"></script>
		<!--<script src="../js/mui.picker.min.js"></script>-->
		<script src="../../js/mui.picker.js"></script>
		<script src="../../js/mui.poppicker.js"></script>
		<script src="../../js/city.data.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
		<!--<script src="../../js/muifun.js"></script>-->
		<script src="../../js/localDatabase.js"></script>
		<script src="../../js/post.js"></script>
		<script src="../../js/dao.js"></script>
		<script src="../../js/linkaddress.js"></script>
		<script src="../../js/member.js"></script>
		<script>
			(function($, doc) {
				$.init();
				$.ready(function() {
					/**
					 * 获取对象属性的值
					 * 主要用于过滤三级联动中，可能出现的最低级的数据不存在的情况，实际开发中需要注意这一点；
					 * @param {Object} obj 对象
					 * @param {String} param 属性名
					 */
					var _getParam = function(obj, param) {
						return obj[param] || '';
					};
					//					//级联示例
					var cityPicker3 = new $.PopPicker({
						layer: 3
					});
					cityPicker3.setData(cityData3);
					var showCityPickerButton = doc.getElementById('showUserPicker');
					var cityResult3 = doc.getElementById('region');
					showCityPickerButton.addEventListener('tap', function(event) {
						cityPicker3.show(function(items) {
							cityResult3.innerText = _getParam(items[0], 'text') + _getParam(items[1], 'text') + _getParam(items[2], 'text');
							//返回 false 可以阻止选择框的关闭
							//return false;
						});
					}, false);
				});
			})(mui, document);
			var price;
			var ShopOrderIdList;
			var address;
			var linkaddress = new LinkAddress();
			var member = new Member();
			mui.init();
			mui.plusReady(function() {
				var _self = plus.webview.currentWebview();
				price = _self.price;
				ShopOrderIdList = _self.data;
				address = _self.address;
				var _getParam = function(obj, param) {
					return obj[param] || '';
				};
				initpage();
			});

			function initpage() {
				setValue('price',"￥ " +price);
				setValue('name', address.LinkManName);
				setValue('phoneNumber', address.Phone);
				document.getElementById('region').innerHTML = splitStr(address.Address)[0];
				console.log(splitStr(address.Address)[0] +"___________"+splitStr(address.Address)[1])
				document.getElementById('txtDescription').value = splitStr(address.Address)[1];
				document.getElementById('btnSave').addEventListener('tap', function() {
					if(getValue('name') == '') {
						mui.toast('请填写姓名');
						return;
					}
					if(!phonecheck(getValue('phoneNumber'))) {
						return;
					}
					if(document.getElementById("region").innerHTML == '选择') {
						mui.toast('请选择所在地区');
						return;
					}
					if(document.getElementById("txtDescription").value == '') {
						mui.toast('请填写详细地址');
						return;
					}
					plus.nativeUI.showWaiting();
//					Model.LinkManName = getValue('name');
//					Model.Phone = getValue('phoneNumber');
					var currentaddress = mergeStr(document.getElementById("region").innerHTML, document.getElementById("txtDescription").value);
					console.log(JSON.stringify(ShopOrderIdList));
//					console.log(getValue('postalCode'));
//					Model.PostCode = getValue('postalCode');
					member.OrderInvoiceApply(address.Id, 0, getValue('name'),null,null,null, currentaddress, getValue('phoneNumber'), getValue('txt') == ""?null:getValue('txt'), price, ShopOrderIdList,function(datas) {
						plus.nativeUI.closeWaiting();
						if(datas.status == 1) {
							dialog.style.display = 'block';
							document.getElementById('dialogone').style.display = 'block';
							document.getElementById('dialogtwo').style.display = 'none';
						} else {
							mui.toast(datas.message);
						}
					}, function() {
						plus.nativeUI.closeWaiting();
						mui.toast('请求失败');
					});
				});
				document.getElementById('casncel').addEventListener('tap', function() {
					dialog.style.display = 'none';
				});
				document.getElementById('close').addEventListener('tap', function() {
					plus.webview.currentWebview().close();
				});
				document.getElementById('back').addEventListener('tap', function() {
					mui.back();
				});
				document.getElementById('notice').addEventListener('tap', function() {
					console.log("AAAAAAAAAAA");
					var task = plus.webview.getWebviewById('invoice_information.html');
					mui.fire(task, 'CreateInvoice');

					//					mui.back();
					plus.webview.getWebviewById('invoice_personal.html').close();
				});

			}

			function getValue(id) {
				return document.getElementById(id).value;
			}

			function setValue(id, value) {
				document.getElementById(id).value = value;
			}

			function splitStr(str) {
				var strlist = str.split(" ");
				return strlist;
			}

			function mergeStr(str1, str2) {
				return str1 + " " + str2;
			}

			//手机号码验证：
			function phonecheck(tel) {
				if(tel.length == 0) {
					mui.toast('请输入手机号码！');
					return false;
				}
				if(tel.length != 11) {
					mui.toast('请输入有效的手机号码！');
					return false;
				}
				var myreg = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
				if(!myreg.test(tel)) {
					mui.toast('请输入有效的手机号码！');
					return false;
				} else {
					return true;
				}
			}

			var old_back = mui.back;
			mui.back = function(event) {
				var dialog = document.getElementById('dialog');
				if(dialog.style.display == 'none') {
					dialog.style.display = 'block';
					return;
				} else {
					dialog.style.display = 'none';
					return;
				}
				return false;
			};

			mui.back = function() {
				plus.webview.currentWebview().close();
			}
		</script>
	</body>

</html>