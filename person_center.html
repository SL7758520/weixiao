<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<title>user</title>
		<link rel="stylesheet" type="text/css" href="css/api.css" />
		<link rel="stylesheet" type="text/css" href="css/common.css" />
		<link rel="stylesheet" href="css/main.css" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<style>
			html,
			body {
				min-width: 320px;
				background-color: #E7E7E7;
			}
			
			.unlogin {
				border-bottom: 1px solid #9D8C7B;
			}
			
			.unlogin img {
				width: 100%;
				-webkit-filter: blur(8px);
				opacity: .7;
			}
			
			.user-img {
				position: absolute;
				top: 20px;
				width: 75px;
				height: 75px;
				left: 0;
				right: 0;
				margin: auto;
				border: 5px solid #9F9887;
				border-radius: 100%;
			}
			
			.user-img img {
				width: 100%;
				height: 100%;
				border-radius: 75px;
			}
			
			.login {
				width: 90px;
				padding: 5px 10px;
				position: absolute;
				top: 110px;
				left: 0;
				right: 0;
				margin: auto;
				background-color: #3BBB65;
				color: #FFFFFF;
			}
			
			.category {
				margin-top: 5px;
				border-bottom: 1px solid #bebebe;
			}
			
			.category li {
				display: inline-block;
				width: 24%;
				text-align: center;
				padding: 20px 0 10px;
				background-size: 30px;
				background-repeat: no-repeat;
				background-position: top;
			}
			
			.category li span {
				margin: 15px 10px 0 10px;
			}
			
			.order {
				background-image: url("../image/user_menu_order@2x.png");
			}
			
			.chat {
				background-image: url("../image/user_menu_chat@2x.png");
			}
			
			.snap_up {
				background-image: url("../image/user_menu_snap_up@2x.png");
			}
			
			.coupon {
				background-image: url("../image/user_menu_coupon@2x.png");
			}
			
			.user-setting li:not(:last-child) {
				position: relative;
				padding: 3px 10px;
				background-size: 20px;
				background-repeat: no-repeat;
				background-position: 95%;
				background-image: url("../image/arrow_grey_right_normal.png");
			}
			
			.user-setting li:last-child {
				position: relative;
				padding: 3px 10px;
			}
			
			.user-setting li:last-child span {
				padding: 10px 0 10px 50px;
			}
			
			.user-setting li:last-child div {
				position: absolute;
				right: 5%;
				top: 13px;
				color: #e6e6e6;
				font-size: 10px;
			}
			
			.user-setting li span {
				display: block;
				padding: 10px 50px;
				background-size: 20px;
				background-repeat: no-repeat;
				background-position: 5%;
			}
			
			.subscribe {
				background-image: url("images/user_menu_subscribe@2x.png");
			}
			
			.favorite {
				background-image: url("images/user_menu_favorite@2x.png");
			}
			
			.comment {
				background-image: url("images/user_menu_comment@2x.png");
			}
			
			.bankcard {
				background-image: url("images/user_menu_bankcard@2x.png");
			}
			
			.message {
				background-image: url("images/user_menu_message@2x.png");
			}
			
			.setting {
				background-image: url("images/user_menu_setting@2x.png");
			}
			
			.update {
				background-image: url("images/user_menu_update@2x.png");
			}
			
			.linecss {
				padding: 15px;
				background-color: #FFFFFF;
				/*				border-bottom: .5px solid #e7e7e7;*/
			}
			
			.loginout {
				border: 1px solid red;
				background-color: red;
			}
		</style>
	</head>

	<body>
		<div class="unlogin" tapmode="">
			<img src="images/t1.jpg">
			<button class="login" id="changepic">修改头像</button>
		</div>
		<div class="user-img">
			<img id="userpic" src="images/user-photo2.png">
		</div>
		<div class="mui-page-content">
			<div class="mui-form">
				<ul>
					<li id="linickname">
						<a href="#" class="linecss">用户名<span id="nickname"></span></a>
					</li>
					<li id="lisex">
						<a href="#" class="linecss">性别<span id="sex"></span></a>
					</li>
					<li id="limobile">
						<a href="#" class="linecss">绑定手机<span id="mobile"></span></a>
					</li>
					<li id="liemail">
						<a href="#" class="linecss">邮箱<span id="email"></span></a>
					</li>
					<li id="liaddress">
						<a href="#" class="linecss">居住地<span id="address"></span></a>
					</li>
					<li id="lipsw">
						<a href="#" class="linecss">修改密码<span></span></a>
					</li>
				</ul>
				<div id="popover_save" class="mui-content-padded">
					<button id="btnSave" type="button" class="mui-btn mui-btn-primary mui-btn-block loginout">退出登录</button>
				</div>
			</div>
			<!--<div class="mui-form" style="margin-top: 5px;">
				<ul>-->
			<!--<li style="border-top: 1px solid #e8e8e8;">
						<a href="#">修改密码<span></span></a>
					</li>-->
			<!--</ul>
			</div>-->
		</div>
	</body>
	<script src="js/mui.min.js"></script>
	<script src="js/post.js"></script>
	<script src="js/localDatabase.js"></script>
	<script src="js/dao.js"></script>
	<script src="js/account.js"></script>
	<script src="js/mui.enterfocus.js"></script>
	<script src="js/app.js"></script>
	<script src="js/member.js"></script>
	<script>
		/*NickName  50
			Sex 2
			Mail 50
			Address 100
			Mobile  20
			IconUrl  100*/
		mui.init();
		var _dataAccess = new DataAccess();
		var Token;
		var member = new Member();
		var isLogin = false;
		mui.plusReady(function() {
			initClick();
			initpage();
//			GetMemberDetail();
			isLogin = getLogin();
			if(isLogin) {
				document.getElementById('btnSave').innerHTML = '退出登录';
			} else {
				document.getElementById('btnSave').innerHTML = '登录';
			}
			document.getElementById('btnSave').addEventListener('tap', function() {
				if(getLogin()) {
					var btnArray = ['是', '否'];
					mui.confirm('您确定要退出登录吗?', '', btnArray, function(e) {
						if(e.index == 0) {
							_dataAccess.logOutUser();
							//			 				plus.runtime.restart();
							if(mui.os.ios || mui.os.ipad || mui.os.iphone) {
								// 获取所有Webview窗口
								var curr = plus.webview.currentWebview();
								var wvs = plus.webview.all();
								for(var i = 0, len = wvs.length; i < len; i++) {
									//关闭除setting页面外的其他页面
									if(wvs[i].getURL() == curr.getURL())
										continue;
									plus.webview.close(wvs[i]);
								}
								//打开main页面后再关闭当前页面
								plus.webview.open('main.html');
								curr.close();
							} else {
								plus.runtime.restart();
								//								plus.webview.open('../login.html');
							}
						}
					});
				} else {
					toLogin();
				}
			});

			document.getElementById("changepic").addEventListener('tap', function() {
				if(!getLogin()) {
					toLogin();
					return;
				}
				if(mui.os.plus) {
					var a = [{
						title: "拍照"
					}, {
						title: "从手机相册选择"
					}];
					plus.nativeUI.actionSheet({
						title: "修改头像",
						cancel: "取消",
						buttons: a
					}, function(b) {
						switch(b.index) {
							case 0:
								break;
							case 1:
								getImage();
								break;
							case 2:
								galleryImg();
								break;
							default:
								break
						}
					})
				}
			});
		});

		function initClick() {
			//修改用户名
			document.getElementById('linickname').addEventListener('tap', function() {
				if(getLogin()) {
					opWindow('html/member/member_modify.html','html/member/member_modify.html','NickName',getelementhtml('nickname'),'修改用户名');
				} else {
					toLogin();
				}
			});
			//修改性别
			document.getElementById('lisex').addEventListener('tap', function() {
				if(getLogin()) {
					opWindow('html/member/member_modify.html','html/member/member_modify.html','Sex',getelementhtml('sex'),'修改性别');
				} else {
					toLogin();
				}
			});
			//修改绑定手机号码
			document.getElementById('limobile').addEventListener('tap', function() {
				mui.toast('暂不提供修改');
				return;
				if(getLogin()) {
					opWindow('html/member/member_modify.html','html/member/member_modify.html','Mobile',getelementhtml('mobile'),'修改手机号');
				} else {
					toLogin();
				}
			});
			//修改邮箱
			document.getElementById('liemail').addEventListener('tap', function() {
				if(getLogin()) {
					opWindow('html/member/member_modify.html','html/member/member_modify.html','Mail',getelementhtml('email'),'修改邮箱');
				} else {
					toLogin();
				}
			});
			//修改居住地
			document.getElementById('liaddress').addEventListener('tap', function() {
				mui.toast('暂不提供修改');
				return;
				if(getLogin()) {
					opWindow('html/member/member_modify.html','html/member/member_modify.html','Address',getelementhtml('address'),'修改居住地');
				} else {
					toLogin();
				}
			});
			
		}
		
		function opWindow(id,url,field,fieldValue,title){
			mui.openWindow({
						id: id,
						url: url,
						show: {
							aniShow: 'pop-in'
						},
						waiting: {
							autoShow: true,
							title: '正在加载...'
						},
						extras: {
							field: field,
							fieldValue:fieldValue,
							title:title
						}
					});
		}

		function toLogin() {
			mui.openWindow({
				id: 'login',
				url: 'html/account/login.html',
				show: {
					aniShow: 'slide-in-bottom'
				},
				waiting: {
					autoShow: true,
					title: '正在加载...'
				}
			});
		}

		function getLogin() {
			if(_dataAccess.getUser() != '{}') {
				return true;
			} else {
				return false;
			}
		}
		
		function initpage() {
				var users = _dataAccess.getUser();
				if (users.Token!=null) {
					Token =users.Token;
				}
				setelementhtml('nickname', users.NickName);
				setelementhtml('mobile', users.Mobile);
				setelementhtml('sex', users.Sex);
				setelementhtml('email', users.Mail);
				if(users.IconUrl != undefined && users.IconUrl != '') {
					//待修改
					document.getElementById('userpic').src = users.IconUrl;
//					document.getElementById('userpic').src = 'http://www.jeffsoft.cn:9801/upload/Member/201709/2017061315445799302963d1050e931.png';
				};
				//				setelementhtml('address',users.Address);
				console.log(JSON.stringify(users));
			}

			function setelementhtml(ElementId, value) {
				if(value == undefined) {
					value = '';
				}
				document.getElementById(ElementId).innerHTML = value;
			}
			function getelementhtml(ElementId) {
				return document.getElementById(ElementId).innerHTML;
			}

		function getImage() {
			var c = plus.camera.getCamera();
			c.captureImage(function(path) {
					plus.io.resolveLocalFileSystemURL(path, function(entry) {
						//						alert("path" + path);
						var s = entry.toLocalURL() + "?version=" + new Date().getTime();
						var zipFileName = path.substr(path.lastIndexOf("/") + 1);
						plus.zip.compressImage({
							src: path,
							dst: '_doc/' + zipFileName,
							overwrite: true,
							quality: 50,
							width:"50%",
							height:"50%"
						}, function(zip) {
							console.log(zip.target);
							document.getElementById("userpic").src = s;
							upload(zip.target);
//							self._addFile(zip.target);
						}, function(zipe) {
							mui.toast('压缩失败！')
						});
					}, function(e) {
						mui.toast("读取拍照文件错误!");
					});
				}
			/*
				plus.io.resolveLocalFileSystemURL(e, function(entry) {
					//将拍照的目录路径变成本地URL路径，如：file:///之类。
					var s = entry.toLocalURL() + "?version=" + new Date().getTime();
					//					console.log('设置里面拍摄的图片是++++++++++++++++++' + s);
					document.getElementById("userpic").src = s;
					//						upload(s);暂未有接口
					//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
				}, function(e) {});
			}*/
			, function(s) {}, {
				filename: "_doc/" + _dataAccess.getUser().IconUrl
			})
		}

		function galleryImg() {
			plus.gallery.pick(function(path) {
				plus.io.resolveLocalFileSystemURL(path, function(entry) {
						//						alert("path" + path);
						var s = entry.toLocalURL() + "?version=" + new Date().getTime();
						var zipFileName = path.substr(path.lastIndexOf("/") + 1);
						plus.zip.compressImage({
							src: path,
							dst: '_doc/' + zipFileName,
							overwrite: true,
							quality: 50,
							width:"50%",
							height:"50%"
						}, function(zip) {
							console.log(zip.target);
							document.getElementById("userpic").src = s;
							upload(zip.target);
//							self._addFile(zip.target);
						}, function(zipe) {
							mui.toast('压缩失败！')
						});
					}, function(e) {});
			}, function(a) {}, {
				filter: "image"
			})
		};
		// 上传文件
		function upload(file) {
			console.log(JSON.stringify(_dataAccess.getUser()));
			var task = plus.uploader.createUpload(globals.apiUrl + 'Member/Upload_ICON?memberid='+_dataAccess.getUser().MemberId, {
				method: 'post',
				timeout: 5000,
			}, function(t, status) {
				var rsp = JSON.parse(t.responseText);
				console.log(JSON.stringify(rsp));
				console.log(status);
				// 上传完成
				if(status == 200) {
					if(rsp.result) {
						//更新用户信息
					GetMemberDetail();
					console.log('成功'+JSON.stringify(rsp));
					}
				} else {
					console.log('失败：'+JSON.stringify(rsp))
					self._refreshPlaceholder(file, 3);
				}
			},function(t){
				console.log(JSON.stringify(JSON.parse(t.responseText)));
			});
			task.setRequestHeader('Authorization',_dataAccess.getUser().Token);
//			task.addData("memberid", _dataAccess.getUser().MemberId);
			task.addFile(file, {
				key: file
			});
			task.start();
		}
		window.addEventListener('Refresh',function(){
			GetMemberDetail();
		});
		function GetMemberDetail(){
			member.GetMemberDetail(function(result){
				var user = result.result;
				user.Token = Token;
				_dataAccess.setUser(user);
				initpage();
			});
		}
	</script>

</html>