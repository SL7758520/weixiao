<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<title>user</title>
		<link rel="stylesheet" type="text/css" href="css/api.css" />
		<link rel="stylesheet" type="text/css" href="css/common.css" />
		<link rel="stylesheet" href="css/main.css" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<style>
		html, body {
   			 min-width: 320px;
   			 background-color: #E7E7E7;
			}
			.unlogin {
				border-bottom: 1px solid #9D8C7B;
			}
			
			.unlogin img {
				width: 100%;
				-webkit-filter: blur(8px);
				opacity: .7;
			}
			
			.user-img {
				position: absolute;
				top: 20px;
				width: 75px;
				height: 75px;
				left: 0;
				right: 0;
				margin: auto;
				border: 5px solid #9F9887;
				border-radius: 100%;
			}
			
			.user-img img {
				width: 100%;
				height: 100%;
				border-radius:75px;
			}
			
			.login {
				width: 90px;
				padding: 5px 10px;
				position: absolute;
				top: 110px;
				left: 0;
				right: 0;
				margin: auto;
				background-color: #3BBB65;
				color: #FFFFFF;
			}
			
			.category {
				margin-top: 5px;
				border-bottom: 1px solid #bebebe;
			}
			
			.category li {
				display: inline-block;
				width: 24%;
				text-align: center;
				padding: 20px 0 10px;
				background-size: 30px;
				background-repeat: no-repeat;
				background-position: top;
			}
			
			.category li span {
				margin: 15px 10px 0 10px;
			}
			
			.order {
				background-image: url("../image/user_menu_order@2x.png");
			}
			
			.chat {
				background-image: url("../image/user_menu_chat@2x.png");
			}
			
			.snap_up {
				background-image: url("../image/user_menu_snap_up@2x.png");
			}
			
			.coupon {
				background-image: url("../image/user_menu_coupon@2x.png");
			}
			
			.user-setting li:not(:last-child) {
				position: relative;
				padding: 3px 10px;
				background-size: 20px;
				background-repeat: no-repeat;
				background-position: 95%;
				background-image: url("../image/arrow_grey_right_normal.png");
			}
			
			.user-setting li:last-child {
				position: relative;
				padding: 3px 10px;
			}
			
			.user-setting li:last-child span {
				padding: 10px 0 10px 50px;
			}
			
			.user-setting li:last-child div {
				position: absolute;
				right: 5%;
				top: 13px;
				color: #e6e6e6;
				font-size: 10px;
			}
			
			.user-setting li span {
				display: block;
				padding: 10px 50px;
				background-size: 20px;
				background-repeat: no-repeat;
				background-position: 5%;
			}
			
			.subscribe {
				background-image: url("images/user_menu_subscribe@2x.png");
			}
			
			.favorite {
				background-image: url("images/user_menu_favorite@2x.png");
			}
			
			.comment {
				background-image: url("images/user_menu_comment@2x.png");
			}
			
			.bankcard {
				background-image: url("images/user_menu_bankcard@2x.png");
			}
			
			.message {
				background-image: url("images/user_menu_message@2x.png");
			}
			
			.setting {
				background-image: url("images/user_menu_setting@2x.png");
			}
			
			.update {
				background-image: url("images/user_menu_update@2x.png");
			}
			.linecss{
				padding: 15px;
				background-color: #FFFFFF;
/*				border-bottom: .5px solid #e7e7e7;*/			
			}
			.loginout{
				border: 1px solid red;
				background-color: red;
			}
		</style>
	</head>

	<body>
		<div class="unlogin" tapmode="" >
			<img src="images/t1.jpg">
			<button class="login" id="changepic">修改头像</button>
		</div>
		<div class="user-img">
			<img id="userpic" src="images/user-photo2.png">
		</div>
		<div class="mui-page-content">
			<div class="mui-form">
				<ul>
					<li>
						<a href="#" class="linecss">用户名<span id="sex">好少年前途似锦</span></a>
					</li>
					<li>
						<a href="#" class="linecss">性别<span id="sex">男</span></a>
					</li>
					<li>
						<a href="#" class="linecss">生日<span id="birthday">1990-01-01</span></a>
					</li>
					<li>
						<a href="#" class="linecss">邮箱<span id="email">ceshi@163.com</span></a>
					</li>
					<li>
						<a href="#" class="linecss">居住地<span id="address">迪拜皇宫</span></a>
					</li>
					<li >
						<a href="#" class="linecss">修改密码<span></span></a>
					</li>
				</ul>
				<div id="popover_save" class="mui-content-padded">
				<button id="btnSave" type="button" class="mui-btn mui-btn-primary mui-btn-block loginout">退出登录</button>
			</div>
			</div>
			<!--<div class="mui-form" style="margin-top: 5px;">
				<ul>-->
					<!--<li style="border-top: 1px solid #e8e8e8;">
						<a href="#">修改密码<span></span></a>
					</li>-->
				<!--</ul>
			</div>-->
		</div>
	</body>
	<script src="js/mui.min.js"></script>
	<script src="js/post.js"></script>
	<script src="js/localDatabase.js"></script>
	<script src="js/dao.js"></script>
	<script src="js/account.js"></script>
	<script src="js/mui.enterfocus.js"></script>
	<script src="js/app.js"></script>
	<script>
		mui.init();
		var _dataAccess = new DataAccess();
		var isLogin =false;
		mui.plusReady(function() {
			isLogin = getLogin();	
			if (isLogin) {
				document.getElementById('btnSave').innerHTML = '退出登录';
			} else{
				document.getElementById('btnSave').innerHTML = '登录';
			}
			document.getElementById('btnSave').addEventListener('tap',function(){
				if(getLogin()) {
					var btnArray = ['是', '否'];
					mui.confirm('您确定要退出登录吗?', '', btnArray, function(e) {
						if(e.index == 0) {
							_dataAccess.logOutUser();
//			 				plus.runtime.restart();
							if(mui.os.ios || mui.os.ipad || mui.os.iphone) {
								// 获取所有Webview窗口
								var curr = plus.webview.currentWebview();
								var wvs = plus.webview.all();
								for(var i = 0, len = wvs.length; i < len; i++) {
									//关闭除setting页面外的其他页面
									if(wvs[i].getURL() == curr.getURL())
										continue;
									plus.webview.close(wvs[i]);
								}
								//打开main页面后再关闭当前页面
								plus.webview.open('main.html');
								curr.close();
							} else {
								plus.runtime.restart();
//								plus.webview.open('../login.html');
							}
						}
					});
				} else {
					mui.openWindow({
						id: 'login',
						url: 'html/account/login.html',
						show: {
							aniShow: 'slide-in-bottom'
						},
						waiting: {
							autoShow: true,
							title: '正在加载...'
						}
					});
				}
			});
			
			document.getElementById("changepic").addEventListener('tap', function() {
				if(mui.os.plus) {
					var a = [{
						title: "拍照"
					}, {
						title: "从手机相册选择"
					}];
					plus.nativeUI.actionSheet({
						title: "修改头像",
						cancel: "取消",
						buttons: a
					}, function(b) {
						switch(b.index) {
							case 0:
								break;
							case 1:
								getImage();
								break;
							case 2:
								galleryImg();
								break;
							default:
								break
						}
					})
				}
			});
		});
		
		function getLogin(){
			if (_dataAccess.getUser()!='{}') {
				return true;
			} else{
				return false;
			}
		}
		
			function getImage() {
				var c = plus.camera.getCamera();
				c.captureImage(function(e) {
					plus.io.resolveLocalFileSystemURL(e, function(entry) {
						//将拍照的目录路径变成本地URL路径，如：file:///之类。
						var s = entry.toLocalURL() + "?version=" + new Date().getTime();
						//					console.log('设置里面拍摄的图片是++++++++++++++++++' + s);
						document.getElementById("userpic").src = s;
//						upload(s);暂未有接口
						//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
						//						document.querySelector("#__mui-imageview__group .mui-slider-item img").src = s /*+ "?version=" + new Date().getTime()*/ ;

					}, function(e) {});
				}, function(s) {}, {
					filename: "_doc/" + _dataAccess.getSetting().HeadUrl
				})
			}

			function galleryImg() {
				plus.gallery.pick(function(a) {
					plus.io.resolveLocalFileSystemURL(a, function(entry) {
						var e = entry.fullPath + "?version=" + new Date().getTime();
						console.log(e);
						document.getElementById("userpic").src = e;
						//						document.querySelector("#__mui-imageview__group .mui-slider-item img").src = e;
//						upload(e);暂未有接口
					}, function(e) {});
				}, function(a) {}, {
					filter: "image"
				})
			};
			// 上传文件
			function upload(file) {
				var task = plus.uploader.createUpload(globals.apiUrl + 'Users.ashx', {
					method: 'post',
					timeout: 5000,
				}, function(t, status) {
					var rsp = JSON.parse(t.responseText);
					// 上传完成
					if(status == 200) {
						if(rsp.Result) {
							//更新用户信息
							upDateUserInfo();
							//				console.log(JSON.stringify(rsp));
						}
					} else {
						self._refreshPlaceholder(file, 3);
					}
				});
				task.addData("Token", _db.getUser().Token);
				task.addData("action", "uploadHeadPic");
				task.addFile(file, {
					key: file
				});
				task.start();
			}
	</script>

</html>